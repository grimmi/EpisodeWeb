<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="./materialize/css/materialize.min.css" media="screen,projection" />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="./materialize/js/materialize.min.js"></script>
    <script type="text/javascript">
        var loadedFiles;

        function getAllCheckedIds() {
            var checkboxes = [];
            var allInputs = document.getElementsByTagName("input");
            for (var i = 0; i < allInputs.length; i++) {
                if (allInputs[i].id.startsWith("cb-") && allInputs[i].checked) {
                    checkboxes.push(allInputs[i].id.replace("cb-", ""));
                }
            }
            return checkboxes;
        }

        function markAll() {
            var allInputs = document.getElementsByTagName("input");
            for (var i = 0; i < allInputs.length; i++) {
                if (allInputs[i].id.startsWith("cb-")) {
                    allInputs[i].checked = true;
                }
            }
        }

        function sendDecode() {
            var ids = getAllCheckedIds();
            var checkedFiles = [];
            for (var i = 0; i < loadedFiles.length; i++) {
                var f = loadedFiles[i];
                if (ids.indexOf(f["Index"].toString()) > -1) {
                    checkedFiles.push(f["Path"]);
                }
            }

            if (checkedFiles.length === 0) {
                return;
            }

            var req = new XMLHttpRequest();
            req.open("POST", "http://localhost:60086/api/decode/DecodeFiles", true);
            req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            req.onload = function (e) {
                console.log("request done!");
            }
            req.send("files=" + checkedFiles);
        }

        function addToTable(encodedfile) {
            var tableList = document.getElementById("encodedlist");

            var newRow = tableList.insertRow(tableList.rows.length);
            var cbCell = newRow.insertCell(0);

            var cb = document.createElement("input");
            cb.setAttribute("type", "checkbox");
            cb.setAttribute("id", "cb-" + encodedfile["Index"]);
            cbCell.appendChild(cb);

            var label = document.createElement("label");
            label.setAttribute("for", "cb-" + encodedfile["Index"]);
            cbCell.appendChild(label);

            var textCell = newRow.insertCell(1);
            var pathElement = document.createTextNode(file["Path"]);
            textCell.appendChild(pathElement);
        }

        function loadfiles(){
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://localhost:60086/api/decode/EncodedFiles", true);
            xhttp.setRequestHeader("Content-Type", "application/json");
            xhttp.onload = function(e) {
                if(xhttp.readyState === 4){
                    if(xhttp.status === 200){
                        var response = JSON.parse(xhttp.responseText);
                        loadedFiles = response["files"];
                        for (file of response["files"]) {
                            addToTable(file);
                        };
                        if (response["files"].length > 0) {
                            document.getElementById("decodeselected").classList.toggle("disabled");
                            document.getElementById("selectall").classList.toggle("disabled");
                            document.getElementById("decodeall").classList.toggle("disabled");
                        }
                    }
                }
            }
            xhttp.send(null);
        }
    </script>
    <div class="container">
        <h1>OTR Manager</h1>
        <ul class="collapsible popout" data-collapsible="expandable">
            <li>
                <div class="collapsible-header active"><img src="./move.png" height="35px" width="35px"/><h5>Dekodieren</h5></div>
                <div class="collapsible-body">
                    <div class="input-field">
                        <input placeholder="z:\downloads\otr" id="source_path" type="text" class="validate">
                        <label for="source_path">Dateipfad angeben</label>
                    </div>
                    <a class="waves-effect waves-light btn" onclick="loadfiles()">Dateien laden</a>
                    <div class="row">
                        <a id="decodeselected" class="waves-effect waves-light btn col s3 disabled" onclick="sendDecode()">Markierte Dateien dekodieren</a>
                        <a id="selectall" class="waves-effect waves-light btn col s3 disabled" onclick="markAll()">Alle Dateien markieren</a>
                        <a id="decodeall" class="waves-effect waves-light btn col s3 disabled">Alle Dateien dekodieren</a>
                    </div>
                    <table class="highlight responsive-table" id="encodedlist">
                        <tr>
                            <th onclick="markAll()">Dekodieren</th>
                            <th>Dateiname</th>
                        </tr>
                    </table>
                </div>
            </li>
            <li>
                <div class="collapsible-header"><img src="./edit.png" height="35px" width="35px"/><h5>Benennen &amp; Verschieben</h5></div>
                <div class="collapsible-body">
                    <div class="input-field">
                        <input placeholder="z:\downloads\otr" id="source_path" type="text" class="validate">
                        <label for="source_path">Dateipfad angeben</label>
                    </div>
                    <a class="waves-effect waves-light btn">Dateien laden</a>
                    <table class="highlight responsive-table">
                        <tr>
                            <th>Verarbeiten</th>
                            <th>Show</th>
                            <th>Episode</th>
                            <th>Dateiname</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="checkbox" id="test21" />
                                <label for="test21"></label>
                            </td>
                            <td>Doctor Who (2005)</td>
                            <td>10x03 Extremis</td>
                            <td>Doctor_Who_17.05.19-19_00-bbc.avi</td>
                        </tr>
                        <tr>
                            <td>
                                <input type="checkbox" id="test22" />
                                <label for="test22"></label>
                            </td>
                            <td>Doctor Who (2005)</td>
                            <td>10x03 Extremis</td>
                            <td>Doctor_Who_17.05.19-19_00-bbc.avi</td>
                        </tr>
                        <tr>
                            <td>
                                <input type="checkbox" id="test23" />
                                <label for="test23"></label>
                            </td>
                            <td>Doctor Who (2005)</td>
                            <td>10x03 Extremis</td>
                            <td>Doctor_Who_17.05.19-19_00-bbc.avi</td>
                        </tr>
                        <tr>
                            <td>
                                <input type="checkbox" id="test24" />
                                <label for="test24"></label>
                            </td>
                            <td>Doctor Who (2005)</td>
                            <td>10x03 Extremis</td>
                            <td>Doctor_Who_17.05.19-19_00-bbc.avi</td>
                        </tr>
                    </table>
                    <div class="row">
                        <a class="waves-effect waves-light btn col s5">Markierte Dateien verarbeiten</a>
                        <div class="col s2"></div>
                        <a class="waves-effect waves-light btn col s5">Alle Dateien verarbeiten</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</body>

</html>